# 比数套件架构设计

## 1. 概述

比数套件用于验证自研芯片算子实现的正确性，支持从单算子到完整图的渐进式比对。

## 2. 核心需求

- **插桩 trace**：自动捕获 golden 数据
- **多格式支持**：npz / raw / proto / 自定义
- **多粒度比对**：bit级 / 分块级 / 完整级
- **精度评估**：abs_err / rel_err / qsnr / cosine
- **可视化**：SVG 热力图
- **用例导出**：失败片段 + 参数
- **归档**：zip 打包

## 3. 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           CLI 层                                │
│                    (prettycli 交互式 / 命令行)                   │
└─────────────────────────────┬───────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                         Tools 层                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │ prepare │  │  trace  │  │ compare │  │ archive │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                         Core 层                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                         │
│  │   log   │  │ registry│  │  utils  │                         │
│  └─────────┘  └─────────┘  └─────────┘                         │
└─────────────────────────────┬───────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────────┐
│                       Formats 层                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │  numpy  │  │   raw   │  │  proto  │  │ custom/ │            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 模块说明

### 4.1 core/

| 模块 | 职责 |
|------|------|
| log.py | 日志（INFO/DEBUG/ERROR） |
| registry.py | 插件注册机制 |
| utils.py | 通用工具函数 |

### 4.2 formats/

| 模块 | 职责 |
|------|------|
| base.py | 格式基类 |
| numpy.py | npz/npy 格式 |
| raw.py | 纯二进制 |
| proto.py | protobuf |
| custom/ | 自定义格式目录 |

### 4.3 trace/

| 模块 | 职责 |
|------|------|
| tracer.py | @trace 装饰器 |
| recorder.py | 数据记录器 |

### 4.4 tools/compare/

| 模块 | 职责 |
|------|------|
| s1_prepare.py | 准备数据，生成 compare.csv |
| s2_diff.py | 比对（bit/分块/完整） |
| s3_report.py | 生成报告 + SVG |
| s4_export.py | 导出失败用例 |
| s5_archive.py | zip 打包 |

## 5. 类图 (UML)

```
┌───────────────────┐
│   FormatBase      │ (abstract)
├───────────────────┤
│ + name: str       │
│ + load()          │
│ + save()          │
└────────┬──────────┘
         │
    ┌────┴────┬────────────┐
    ▼         ▼            ▼
┌────────┐ ┌────────┐ ┌────────────┐
│ Numpy  │ │  Raw   │ │ CustomFmt  │
└────────┘ └────────┘ └────────────┘


┌───────────────────┐
│   Comparator      │
├───────────────────┤
│ + compare_bit()   │
│ + compare_block() │
│ + compare_full()  │
│ + calc_qsnr()     │
└───────────────────┘


┌───────────────────┐
│   Tracer          │
├───────────────────┤
│ + trace()         │  装饰器
│ + dump()          │  导出数据
│ + gen_csv()       │  生成 compare.csv
└───────────────────┘
```

## 6. 数据流

```
                    ┌─────────────┐
                    │ Golden 代码 │
                    │ (@trace)    │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   prepare   │ → compare.csv (初版)
                    └──────┬──────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │  golden  │    │  仿真器  │    │  用户    │
    │  .bin    │    │  输出    │    │  编辑csv │
    └──────────┘    └──────────┘    └──────────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
                    ┌─────────────┐
                    │    diff     │ → 比对结果
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   report    │ → SVG + 摘要
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   export    │ → 失败用例
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   archive   │ → .zip
                    └─────────────┘
```

## 7. 文件命名规范

| 类型 | 命名规则 | 示例 |
|------|----------|------|
| golden | `{op}_golden.bin` | conv2d_0_golden.bin |
| 仿真输出 | `{op}_sim_out.bin` | conv2d_0_sim_out.bin |
| 输入 | `{op}_input.bin` | conv2d_0_input.bin |
| 权重 | `{op}_weight.bin` | conv2d_0_weight.bin |
| compare表 | `{model}_compare.csv` | resnet_compare.csv |
| 详情目录 | `details/{op}/` | details/conv2d_0/ |

## 8. 日志规范

```python
# 级别
LOG_DEBUG  # 调试信息，开发用
LOG_INFO   # 正常流程
LOG_WARN   # 警告
LOG_ERROR  # 错误

# 格式
[2024-01-18 10:30:00] [INFO] [compare] conv2d_0: PASS (qsnr=45.3dB)
[2024-01-18 10:30:01] [WARN] [compare] relu_0: 跳过 (仿真器无法导出)
[2024-01-18 10:30:02] [ERROR] [compare] pool_0: FAIL (qsnr=12.1dB)
```
